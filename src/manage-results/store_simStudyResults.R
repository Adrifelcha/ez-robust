#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!
# This script contains functions to process the combined output from a simulation study
# (as generated by `load_seedOutput`) and store it in a cell-specific .RData file
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~!
store_simStudyResults <- function(output, saveTo = "./"){
    # Create the output directory if it doesn't exist
    dir.create(saveTo, recursive = TRUE, showWarnings = FALSE)
    
    # Fixed simulation levels (these are not extracted from the output, as I change as I go)
    participant_levels <- c(20, 40, 80, 160, 320)
    trial_levels <- c(20, 40, 80, 160, 320)
    beta_levels <-  c(0, 0.1, 0.2, 0.4, 0.8)
    
    # Extract simulation settings from the output
    n_seeds <- nrow(output$reps)
    param_names <- c(output$settings$jagsParameters)
    
  # Identify available top-level result dataframes (e.g., "noEffect", "fixedEffect")
    available_results <- setdiff(names(output), c("reps", "settings"))

    merge_results <- output[[available_results[1]]]
    for(i in 2:length(available_results)){
      merge_results <- rbind(merge_results, output[[available_results[i]]])
    }

  # Identify the model and data conditions
    subCell_conditions <- colnames(merge_results)

  # Loop over each model condition column and process it
  for(condition_name in subCell_conditions){
      cat(paste0("\nProcessing: ", condition_name, "\n"))
    
      # Call the helper function to extract and structure the data
      processed_data <- read_subCell(subCell = merge_results[,condition_name],
                                     condition_col_name = condition_name,
                                     settings = output$settings,
                                     reps = output$reps,
                                     participant_levels = participant_levels,
                                     trial_levels = trial_levels,
                                     beta_levels = beta_levels,
                                     n_seeds = n_seeds,
                                     param_names = param_names,
                                     saveTo = saveTo)
  }
  cat("\nProcessing complete.\n") 
} 



read_subCell <- function(subCell, condition_col_name, settings, reps, participant_levels, 
                         trial_levels, beta_levels, n_seeds, param_names, saveTo) {
 
  subCell_ID <- name_subCell_ID(subCell_name = condition_col_name)
  nParams <- length(param_names)

  target_folder <- here(saveTo, condition_col_name)
  dir.create(target_folder, recursive = TRUE, showWarnings = FALSE)

  # Process each beta level separately
  for(p in participant_levels){
        for(t in trial_levels){              
              # Isolate the results that match this cell design
              matching_results <- Filter(function(x) x$p == p && x$t == t, subCell)
              if(length(matching_results) == 0){next}

              # Extract the rhats, true values, mean estimates, and std estimates for this cell design
              rhats_matrix <- t(sapply(matching_results, function(x) x$rhats))              
              rhats_matrix <- rhats_matrix[,param_names]
              true_values_matrix <- t(sapply(matching_results, function(x) x$true.values))              
              true_values_matrix <- true_values_matrix[,param_names]
              mean_estimates_matrix <- t(sapply(matching_results, function(x) x$mean.estimates))              
              mean_estimates_matrix <- mean_estimates_matrix[,param_names]
              std_estimates_matrix <- t(sapply(matching_results, function(x) x$std.estimates))              
              std_estimates_matrix <- std_estimates_matrix[,param_names]
              credInterval_matrix <- t(sapply(matching_results, function(x) x$credInterval))
              credInterval_matrix <- credInterval_matrix[,param_names]
                                          
              beta_chains_matrix <- t(sapply(matching_results, function(x) x$beta_chains))
              names(beta_chains_matrix) <- sapply(matching_results, function(x) x$seed)                           

              summary_matrix <- data.frame("seed" = sapply(matching_results, function(x) x$seed),
                                           "jagsTime" = c(t(sapply(matching_results, function(x) x$jagsTime))),
                                           "nIter" = c(t(sapply(matching_results, function(x) x$nIter))),
                                           "nBurnin" = c(t(sapply(matching_results, function(x) x$nBurnin))),
                                           "nThin" = c(t(sapply(matching_results, function(x) x$nThin))),
                                           "bad_rhats" = c(t(sapply(matching_results, function(x) x$bad_rhat_count))))

              # Create a list with all processed results for this beta level
              simStudy_Beta <- list("true" = true_values_matrix,
                                    "estimates" = mean_estimates_matrix,
                                    "error.sd" = std_estimates_matrix,
                                    "rhats" = rhats_matrix,
                                    "credInterval" = credInterval_matrix,
                                    "beta_chains" = beta_chains_matrix,                                    
                                    "summary" = summary_matrix)
            
              outputFile <- name_simStudyCell(nTrials = t, nParticipants = p, nDatasets = n_seeds, 
                                              data_type = subCell_ID$data_type, 
                                              ez_model = subCell_ID$EZ_model, output.folder = target_folder)
            
            # Save the processed results to a file
            save(simStudy_Beta, file=outputFile)
      }
   }  
}