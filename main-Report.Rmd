---
title: "Robust EZ-DDM explorations"
author: "Adriana, Eunice, and Joachim"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: true
    cards: false
    highlight: tango
    fig_width: 12 
    fig_height: 8 
    css: src/custom.css
---

```{r, echo = FALSE, message = FALSE}
library(here)
library(knitr)
library(kableExtra) 
library(tidyverse)
library(R2jags)

# Load custom functions
for(archive in dir(here("src"))){    source(paste(here("src/"),archive,sep=""))     }
```

# Introduction

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Create the data frame
my_data <- data.frame(
  FactorB = c("EZ-DDM", "Robust EZ-DDM"),
  FactorA1 = c("Test 1", "Test 4"),
  FactorA2 = c("Test 2", "Test 5"),
  FactorA3 = c("Test 3", "Test 6")
)

# Generate the table using kable
kable(my_data, 
      col.names = c("Model","Clean trial-by-trial data", "Clean summary statistic data", "Trial-by-trial data with outliers"), # Set column names, empty for the first
      align = 'lccc') %>%                        # Align columns (left, center, center)
  kable_styling(bootstrap_options = c("striped", "bordered"), # Add styling
                full_width = FALSE)             # Prevent table from spanning full page width
```


## True parameter values

```{r}
# True hierarchical means
drift_mean <- 0      # Drift rate mean
bound_mean <- 1.5    # Boundary separation mean
nondt_mean <- 0.4    # Non-decision time mean

# Design settings
nParticipants <- 40
nTrials <- 160
```

```{r}
# Create a set of individual parameters
indiv_params <- sample_indivParams(n_participants = nParticipants, 
                                   dmean = drift_mean, bmean = bound_mean, nmean = nondt_mean)

# Print the first 10 rows showing the individual parameters
head(indiv_params, 10)
```


# Bayesian EZ-DDM model

```{r, echo=FALSE}
# Prepare the parameters defining the prior distributions
priors <- list(
      # Priors for Population Means (Normal distributions)
      bound_mean_mean = 1.5, bound_mean_sdev = 1.0,
      nondt_mean_mean = 0.3, nondt_mean_sdev = 0.5,
      drift_mean_mean = 2.0, drift_mean_sdev = 1.5,

      # Priors for Population-level Standard Deviations (Uniform)
      bound_sdev_lower = 0.1, bound_sdev_upper = 1.0,
      nondt_sdev_lower = 0.05, nondt_sdev_upper = 0.5,
      drift_sdev_lower = 0.2, drift_sdev_upper = 1.5
)

# Write the JAGS model if not already written
modelFile <- here::here("output", "BUGS-models", "JAGS_model.txt")
if(!file.exists(modelFile)){
  JAGS_writeModel(priors = priors, modelFile = modelFile, custom_truncation_list = NULL)
}

# Print the JAGS model to the console
model_content <- readLines(modelFile)
cat(model_content, sep = "\n")
```

## JAGS setup

```{r}
# General setup
n.chains  <- 4;      n.iter    <- 3500
n.burnin  <- 250;    n.thin    <- 1

# Specify parameters to keep track of
parameters <- c('bound_mean', 'nondt_mean', 'drift_mean', 'bound', 'nondt', 'drift')

myinits <- rep(list(list()), n.chains)
          for(i in 1:n.chains){
              myinits[[i]] <- list(drift = rnorm(nParticipants,1,0.1))
          }
```

# Test 1 and 2: Clean trial-by-trial data

Tests 1 and 2 use clean data sampled from a Wiener process.

## Get data

```{r}
data_cleanFull <- sample_data(nPart = nParticipants, nTrials = nTrials, parameter_set = indiv_params)
head(data_cleanFull)
```

## Compute summary statistics from trial-by-trial data

```{r}
summStats <- get_summaryStats(data_cleanFull)
head(summStats)
```

## Test 1: EZ-DDM

```{r}
# We use the EZ-DDM summary statistics to pass data to JAGS
data_toJAGS <- list("nTrialsPerPerson"  =  nTrials,
                    "nParticipants"    =  nParticipants,
                    "meanRT"   =  summStats[,"meanRT"],
                    "varRT"    =  summStats[,"varRT"],
                    "correct"  =  summStats[,"sum_correct"])
```

```{r, warning = FALSE, results = "hide"}
start <- Sys.time()
samples <- jags(data=data_toJAGS, parameters.to.save=parameters,
                model=modelFile, n.chains=n.chains,  n.iter=n.iter,
                n.burnin=n.burnin,  n.thin=n.thin, DIC=T, inits=myinits,
                quiet=TRUE)
end <- Sys.time()
```

```{r, echo=FALSE}
cat("Time taken:", round(difftime(end, start, units = "secs"), 2), "seconds")
```

```{r, echo=FALSE}
# Extract the posterior samples
bound_mean1 <- samples$BUGSoutput$sims.list$bound_mean
nondt_mean1 <- samples$BUGSoutput$sims.list$nondt_mean
drift_mean1 <- samples$BUGSoutput$sims.list$drift_mean
```

```{r, echo=FALSE}
# Find the maximum density value across all three parameters
max_density <- max(
  max(density(bound_mean1)$y),
  max(density(nondt_mean1)$y),
  max(density(drift_mean1)$y)
)

# Set up the plotting area with 3 panels side by side
par(mfrow=c(1,3), mar=c(4,4,2,2))

# Plot each posterior with the same y-axis limit

plot_posterior <- function(density_data, parameter_name, color, max_density=NA, true_value=NA){
  if(is.na(max_density)){
    max_density <- max(density(density_data)$y)
  }

  minX <- min(c(min(density(density_data)$x), -0.1))
  maxX <- max(c(max(density(density_data)$x), 0.1))

  if(parameter_name == "bound_mean"){
    main_title <- "Hierarchical mean boundary separation"
    color <- "red"
  } else if(parameter_name == "nondt_mean"){
    main_title <- "Hierarchical mean non-decision time"
    color <- "darkgreen"
  } else if(parameter_name == "drift_mean"){
    main_title <- "Hierarchical mean drift rate"
    color <- "blue"
  }

  plot(density(density_data), main=main_title, ylim=c(0, max_density), xlim=c(minX, maxX), ann=FALSE, axes=FALSE)
  polygon(density(density_data), col=rgb(0.8, 0.2, 0.2, 0.5), border="red")

  if(!is.na(true_value)){
    abline(v = true_value, col = "black", lty = 2)
  }
}

plot_posterior(bound_mean1, "bound_mean", "red", max_density)
plot_posterior(nondt_mean1, "nondt_mean", "darkgreen", max_density)
plot_posterior(drift_mean1, "drift_mean", "blue", max_density)

# Reset the plotting parameters
par(mfrow=c(1,1))
```


## Test 2: Robust EZ-DDM

```{r}
# We use the EZ-DDM summary statistics to pass data to JAGS
data_toJAGS <- list("nTrialsPerPerson"  =  nTrials,
                    "nParticipants"    =  nParticipants,
                    "meanRT"   =  summStats[,"medianRT"],
                    "varRT"    =  summStats[,"iqrRT"],
                    "correct"  =  summStats[,"sum_correct"])
```

```{r, warning = FALSE, results = "hide"}
start <- Sys.time()
samples <- jags(data=data_toJAGS, parameters.to.save=parameters,
                model=modelFile, n.chains=n.chains,  n.iter=n.iter,
                n.burnin=n.burnin,  n.thin=n.thin, DIC=T, inits=myinits,
                quiet=TRUE)
end <- Sys.time()
```

```{r, echo=FALSE}
cat("Time taken:", round(difftime(end, start, units = "secs"), 2), "seconds")
```

# Test 3 and 4: Clean summary statistic data

Tests 3 and 4 use clean data (i.e., no outliers), but instead of generating trial-by-trial data, we use the EZ-DDM equations and implied sampling distribution to generate summary statistics.

## Test 3: EZ-DDM with outliers

## Test 4: Robust EZ-DDM with outliers

# Test 5 and 6: Trial-by-trial data with outliers

Tests 5 and 6 use trial-by-trial data, with outlier RTs.

## Test 5: EZ-DDM with outliers

## Test 6: Robust EZ-DDM with outliers

